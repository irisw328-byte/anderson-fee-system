<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸æ ¡ç°¡æ˜“æ”¶è²»ç³»çµ± v2.0</title>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-radius: 8px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Header & Navigation */
        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 { color: var(--primary-color); }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            background-color: #e0e0e0;
            cursor: pointer;
            border-radius: var(--border-radius);
            font-weight: bold;
            transition: 0.3s;
        }

        .nav-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* Sections */
        .section {
            display: none;
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s;
        }

        .section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        label { display: block; margin-bottom: 5px; font-weight: 600; }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: background 0.2s;
        }

        .btn:hover { opacity: 0.9; }

        .btn-primary { background-color: var(--primary-color); }
        .btn-success { background-color: #2a9d8f; }
        .btn-warning { background-color: #fca311; color: #333; }
        .btn-danger { background-color: #e63946; padding: 5px 10px; font-size: 0.8em;}

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        th { background-color: #f1f1f1; }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .stat-card h3 { margin: 0; font-size: 2em; }
        .stat-card p { margin: 5px 0 0 0; opacity: 0.9; }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        #notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #2a9d8f;
            color: white;
            padding: 15px 25px;
            border-radius: 4px;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ“ å­¸æ ¡ç°¡æ˜“æ”¶è²»ç³»çµ±</h1>
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="showSection('payment')">ğŸ’° ç¹³è²»æ«ƒå°</button>
            <button class="nav-btn" onclick="showSection('records')">ğŸ“Š è²¡å‹™å ±è¡¨</button>
            <button class="nav-btn" onclick="showSection('students')">ğŸ‘¨â€ğŸ“ å­¸ç”Ÿç®¡ç†</button>
            <button class="nav-btn" onclick="showSection('fees')">ğŸ“ è²»ç”¨è¨­å®š</button>
        </div>
    </header>

    <!-- Payment Section -->
    <div id="payment" class="section active">
        <h2>æ–°å¢ç¹³è²»ç´€éŒ„</h2>
        <div class="dashboard-grid">
            <div class="form-group">
                <label>é¸æ“‡å­¸ç”Ÿï¼š</label>
                <select id="payStudentSelect"></select>
            </div>
            <div class="form-group">
                <label>é¸æ“‡è²»ç”¨é …ç›®ï¼š</label>
                <select id="payFeeSelect"></select>
            </div>
        </div>
        <div class="form-group">
            <label>é‡‘é¡ç¢ºèª (TWD)ï¼š</label>
            <input type="number" id="payAmountDisplay" readonly>
        </div>
        <button class="btn btn-success" onclick="processPayment()" style="width: 100%; font-size: 1.2em;">ç¢ºèªç¹³è²»</button>
    </div>

    <!-- Records Section -->
    <div id="records" class="section">
        <h2>è²¡å‹™æ¦‚æ³</h2>
        <div class="dashboard-grid">
            <div class="stat-card">
                <h3 id="totalIncome">NT$0</h3>
                <p>ç¸½æ”¶å…¥</p>
            </div>
            <div class="stat-card" style="background-color: #2a9d8f;">
                <h3 id="totalTransactions">0</h3>
                <p>ç¹³è²»ç­†æ•¸</p>
            </div>
        </div>
        
        <h3>è©³ç´°äº¤æ˜“ç´€éŒ„</h3>
        <div class="action-bar">
            <button class="btn btn-warning" onclick="exportToExcel()">ğŸ“¥ åŒ¯å‡º Excel (CSV)</button>
            <button class="btn btn-danger" onclick="clearAllData()">âš ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>æ™‚é–“</th>
                    <th>å­¸ç”Ÿå§“å</th>
                    <th>è²»ç”¨é …ç›®</th>
                    <th>é‡‘é¡</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="recordsTableBody"></tbody>
        </table>
    </div>

    <!-- Students Section -->
    <div id="students" class="section">
        <h2>å­¸ç”Ÿåå–®ç®¡ç†</h2>
        <div class="form-group" style="display: flex; gap: 10px;">
            <input type="text" id="newStudentName" placeholder="è¼¸å…¥å­¸ç”Ÿå§“å (ä¾‹å¦‚ï¼šç‹å°æ˜)">
            <input type="text" id="newStudentId" placeholder="å­¸è™Ÿ (é¸å¡«)">
            <button class="btn btn-primary" onclick="addStudent()">æ–°å¢å­¸ç”Ÿ</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>å­¸è™Ÿ</th>
                    <th>å§“å</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="studentTableBody"></tbody>
        </table>
    </div>

    <!-- Fees Section -->
    <div id="fees" class="section">
        <h2>è²»ç”¨é …ç›®è¨­å®š</h2>
        <div class="form-group" style="display: flex; gap: 10px;">
            <input type="text" id="newFeeName" placeholder="è²»ç”¨åç¨± (ä¾‹å¦‚ï¼šå­¸æœŸæ›¸æœ¬è²»)">
            <input type="number" id="newFeeAmount" placeholder="é‡‘é¡">
            <button class="btn btn-primary" onclick="addFeeType()">æ–°å¢è²»ç”¨</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>è²»ç”¨åç¨±</th>
                    <th>é è¨­é‡‘é¡</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="feeTableBody"></tbody>
        </table>
    </div>
</div>

<div id="notification">æ“ä½œæˆåŠŸï¼</div>

<script>
    const DB_KEYS = {
        STUDENTS: 'school_students',
        FEES: 'school_fees',
        RECORDS: 'school_records'
    };

    let students = JSON.parse(localStorage.getItem(DB_KEYS.STUDENTS)) || [];
    let feeTypes = JSON.parse(localStorage.getItem(DB_KEYS.FEES)) || [];
    let records = JSON.parse(localStorage.getItem(DB_KEYS.RECORDS)) || [];

    window.onload = function() {
        renderAll();
        document.getElementById('payFeeSelect').addEventListener('change', updatePayAmount);
    };

    function saveData() {
        localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify(students));
        localStorage.setItem(DB_KEYS.FEES, JSON.stringify(feeTypes));
        localStorage.setItem(DB_KEYS.RECORDS, JSON.stringify(records));
        renderAll();
    }

    function renderAll() {
        renderStudents();
        renderFees();
        renderRecords();
        renderPaymentOptions();
        updateDashboard();
    }

    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        
        document.getElementById(sectionId).classList.add('active');
        
        const buttons = document.querySelectorAll('.nav-btn');
        if(sectionId === 'payment') buttons[0].classList.add('active');
        if(sectionId === 'records') buttons[1].classList.add('active');
        if(sectionId === 'students') buttons[2].classList.add('active');
        if(sectionId === 'fees') buttons[3].classList.add('active');
    }

    function showNotification(msg) {
        const notif = document.getElementById('notification');
        notif.textContent = msg;
        notif.style.display = 'block';
        setTimeout(() => { notif.style.display = 'none'; }, 3000);
    }

    function addStudent() {
        const nameInput = document.getElementById('newStudentName');
        const idInput = document.getElementById('newStudentId');
        const name = nameInput.value.trim();
        const id = idInput.value.trim() || 'S' + (students.length + 1).toString().padStart(3, '0');

        if (!name) return alert('è«‹è¼¸å…¥å­¸ç”Ÿå§“å');

        students.push({ id, name });
        nameInput.value = '';
        idInput.value = '';
        saveData();
        showNotification(`å·²æ–°å¢å­¸ç”Ÿï¼š${name}`);
    }

    function deleteStudent(index) {
        if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å­¸ç”Ÿå—ï¼Ÿ')) {
            students.splice(index, 1);
            saveData();
        }
    }

    function renderStudents() {
        const tbody = document.getElementById('studentTableBody');
        tbody.innerHTML = students.map((s, index) => `
            <tr>
                <td>${s.id}</td>
                <td>${s.name}</td>
                <td><button class="btn btn-danger" onclick="deleteStudent(${index})">åˆªé™¤</button></td>
            </tr>
        `).join('');
    }

    function addFeeType() {
        const nameInput = document.getElementById('newFeeName');
        const amountInput = document.getElementById('newFeeAmount');
        const name = nameInput.value.trim();
        const amount = Number(amountInput.value);

        if (!name || amount <= 0) return alert('è«‹è¼¸å…¥æ­£ç¢ºçš„è²»ç”¨åç¨±èˆ‡é‡‘é¡');

        feeTypes.push({ id: Date.now(), name, amount });
        nameInput.value = '';
        amountInput.value = '';
        saveData();
        showNotification(`å·²æ–°å¢è²»ç”¨é …ç›®ï¼š${name}`);
    }

    function deleteFee(index) {
        if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è²»ç”¨é …ç›®å—ï¼Ÿ')) {
            feeTypes.splice(index, 1);
            saveData();
        }
    }

    function renderFees() {
        const tbody = document.getElementById('feeTableBody');
        tbody.innerHTML = feeTypes.map((f, index) => `
            <tr>
                <td>${f.name}</td>
                <td>NT$${f.amount}</td>
                <td><button class="btn btn-danger" onclick="deleteFee(${index})">åˆªé™¤</button></td>
            </tr>
        `).join('');
    }

    function renderPaymentOptions() {
        const sSelect = document.getElementById('payStudentSelect');
        const fSelect = document.getElementById('payFeeSelect');
        const currentStudent = sSelect.value;

        sSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡å­¸ç”Ÿ --</option>' + 
            students.map(s => `<option value="${s.name}">${s.id} - ${s.name}</option>`).join('');
            
        fSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡è²»ç”¨ --</option>' + 
            feeTypes.map((f, index) => `<option value="${index}">${f.name} (NT$${f.amount})</option>`).join('');

        if(currentStudent) sSelect.value = currentStudent;
        updatePayAmount();
    }

    function updatePayAmount() {
        const fSelect = document.getElementById('payFeeSelect');
        const amountDisplay = document.getElementById('payAmountDisplay');
        
        if (fSelect.value !== "") {
            const index = fSelect.value;
            amountDisplay.value = feeTypes[index].amount;
        } else {
            amountDisplay.value = '';
        }
    }

    function processPayment() {
        const sSelect = document.getElementById('payStudentSelect');
        const fSelect = document.getElementById('payFeeSelect');
        const amountDisplay = document.getElementById('payAmountDisplay');

        if (!sSelect.value || fSelect.value === "") {
            return alert('è«‹é¸æ“‡å­¸ç”Ÿèˆ‡è²»ç”¨é …ç›®');
        }

        const studentName = sSelect.value;
        const fee = feeTypes[fSelect.value];
        const actualAmount = Number(amountDisplay.value);

        const record = {
            id: Date.now(),
            date: new Date().toLocaleString(),
            studentName: studentName,
            feeName: fee.name,
            amount: actualAmount
        };

        records.unshift(record);
        saveData();
        showNotification('ç¹³è²»æˆåŠŸï¼');
        sSelect.value = "";
    }

    function renderRecords() {
        const tbody = document.getElementById('recordsTableBody');

        if (records.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#888;">ç›®å‰å°šç„¡ç¹³è²»ç´€éŒ„</td></tr>';
            return;
        }

        tbody.innerHTML = records.map((r, index) => `
            <tr>
                <td>${r.date}</td>
                <td>${r.studentName}</td>
                <td>${r.feeName}</td>
                <td style="color: var(--success-color); font-weight:bold;">NT$${r.amount}</td>
                <td><button class="btn btn-danger" onclick="deleteRecord(${index})">æ’¤éŠ·</button></td>
            </tr>
        `).join('');
    }

    function deleteRecord(index) {
        if(confirm('ç¢ºå®šè¦æ’¤éŠ·é€™ç­†ç¹³è²»ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
            records.splice(index, 1);
            saveData();
        }
    }

    function updateDashboard() {
        const total = records.reduce((sum, r) => sum + r.amount, 0);
        document.getElementById('totalIncome').textContent = `NT$${total.toLocaleString()}`;
        document.getElementById('totalTransactions').textContent = records.length;
    }

    function clearAllData() {
        if(confirm('é€™å°‡åˆªé™¤æ‰€æœ‰å­¸ç”Ÿã€è²»ç”¨è¨­å®šå’Œç¹³è²»ç´€éŒ„ï¼ç¢ºå®šå—ï¼Ÿ')) {
            if(confirm('å†æ¬¡ç¢ºèªï¼šè³‡æ–™å°‡ç„¡æ³•å¾©åŸï¼')) {
                localStorage.clear();
                students = [];
                feeTypes = [];
                records = [];
                renderAll();
                showNotification('ç³»çµ±å·²é‡ç½®');
            }
        }
    }

    function exportToExcel() {
        if (records.length === 0) {
            return alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºå–”ï¼");
        }

        let csvContent = "\uFEFF"; 
        csvContent += "æ™‚é–“,å­¸ç”Ÿå§“å,è²»ç”¨é …ç›®,é‡‘é¡\n";

        records.forEach(row => {
            csvContent += `"${row.date}","${row.studentName}","${row.feeName}",${row.amount}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");

        const date = new Date();
        const filename = `è²¡å‹™å ±è¡¨_${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}${date.getDate()}.csv`;

        link.href = url;
        link.download = filename;
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showNotification("å ±è¡¨å·²ä¸‹è¼‰ï¼");
    }
</script>

</body>
</html>
